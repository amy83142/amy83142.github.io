/*門急診*/
LIBNAME OPD_ "C:\Users\User\Desktop\模擬數據檔\Health-01";
/*住院*/
LIBNAME INPD_ "C:\Users\User\Desktop\模擬數據檔\Health-02";
/*承保檔*/
LIBNAME ENROL_ "C:\Users\User\Desktop\模擬數據檔\Health-07";
/*死因*/
LIBNAME DEA_ "C:\Users\User\Desktop\模擬數據檔\Health-10";
/*評鑑等級*/
LIBNAME HOSB_ "C:\Users\User\Desktop\模擬數據檔\Health-11";(沒外釋);
/*癌症場表LF*/
LIBNAME CRC_ "C:\Users\User\Desktop\模擬數據檔\Health-14";
/*癌症登記年報*/
LIBNAME CRTX_ "C:\Users\User\Desktop\模擬數據檔\Health-45";
/*個人屬性*/
LIBNAME SOC_ "C:\Users\User\Desktop\模擬數據檔\Socity09";

/*COPY*/
LIBNAME DATAID 'C:\Users\User\Desktop\資科中心\練習\DATAID';
LIBNAME DATAOP 'C:\Users\User\Desktop\資科中心\練習\DATAOP';
LIBNAME DATAINP 'C:\Users\User\Desktop\資科中心\練習\DATAINP';
LIBNAME DATAHSDC 'C:\Users\User\Desktop\資科中心\練習\DATAHSDC';

LIBNAME DATAMEN 'C:\Users\User\Desktop\資科中心\練習\DATAMEN';
LIBNAME DATACAN 'C:\Users\User\Desktop\資科中心\練習\DATACAN';
LIBNAME ALLDATA 'C:\Users\User\Desktopl\資科中心\練習\ALLDATA';
LIBNAME CCI 'C:\Users\User\Desktop\資科中心\練習\CCI';

/*合併 HEALTH-07_承保檔(月份) NHI_ENROL to 年份 */
%MACRO ID94_99; 
	%DO A= 94 %TO 99; 
		DATA DATAID.ID&A.; 
		SET 
			ENROL_.h_nhi_enrol&A.01 ENROL_.h_nhi_enrol&A.02 ENROL_.h_nhi_enrol&A.03 ENROL_.h_nhi_enrol&A.04 
			ENROL_.h_nhi_enrol&A.05 ENROL_.h_nhi_enrol&A.06 ENROL_.h_nhi_enrol&A.07 ENROL_.h_nhi_enrol&A.08
			ENROL_.h_nhi_enrol&A.09 ENROL_.h_nhi_enrol&A.10 ENROL_.h_nhi_enrol&A.11 ENROL_.h_nhi_enrol&A.12;
		KEEP ID ID_S ID1_DIVISION ID1_UNIT ID1_CITY ID1_AMT ID1_IDENT ID_STATUS; 
		RUN; 
	%END; 
%MEND; %ID94_99; 
%MACRO ID100_104; 
	%DO A= 100 %TO 104; 
		DATA DATAID.ID&A.; 
		SET 
			ENROL_.h_nhi_enrol&A.01 ENROL_.h_nhi_enrol&A.02 ENROL_.h_nhi_enrol&A.03 ENROL_.h_nhi_enrol&A.04 
			ENROL_.h_nhi_enrol&A.05 ENROL_.h_nhi_enrol&A.06 ENROL_.h_nhi_enrol&A.07 ENROL_.h_nhi_enrol&A.08
			ENROL_.h_nhi_enrol&A.09 ENROL_.h_nhi_enrol&A.10 ENROL_.h_nhi_enrol&A.11 ENROL_.h_nhi_enrol&A.12;
		KEEP ID ID_S ID1_DIVISION ID1_UNIT ID1_CITY ID1_AMT ID1_IDENT ID_STATUS; 
		RUN; 
	%END; 
%MEND; %ID100_104; 
/*ID yearly data*/
DATA DATAID.ID_ALL;
	SET DATAID.ID94 DATAID.ID95 DATAID.ID96 DATAID.ID97 DATAID.ID98
			DATAID.ID99 DATAID.ID100 DATAID.ID101 DATAID.ID102 DATAID.ID103 DATAID.ID104;
	RUN;

/*合併 HEALTH-01_門急診(月份) NHI_ENROL to 年份 */
	/* _10 西醫  _20 牙醫  _30 中醫 */
%MACRO OP94_99; 
	%DO A= 94 %TO 99; 
		DATA DATAOP.OP&A.; 
		SET 
			OPD_.h_nhi_opdte&A.01_10 OPD_.h_nhi_opdte&A.01_20 OPD_.h_nhi_opdte&A.01_30
			OPD_.h_nhi_opdte&A.02_10 OPD_.h_nhi_opdte&A.02_20 OPD_.h_nhi_opdte&A.02_30
			OPD_.h_nhi_opdte&A.03_10 OPD_.h_nhi_opdte&A.03_20 OPD_.h_nhi_opdte&A.03_30
			OPD_.h_nhi_opdte&A.04_10 OPD_.h_nhi_opdte&A.04_20 OPD_.h_nhi_opdte&A.04_30
			OPD_.h_nhi_opdte&A.05_10 OPD_.h_nhi_opdte&A.05_20 OPD_.h_nhi_opdte&A.05_30
			OPD_.h_nhi_opdte&A.06_10 OPD_.h_nhi_opdte&A.06_20 OPD_.h_nhi_opdte&A.06_30
			OPD_.h_nhi_opdte&A.07_10 OPD_.h_nhi_opdte&A.07_20 OPD_.h_nhi_opdte&A.07_30
			OPD_.h_nhi_opdte&A.08_10 OPD_.h_nhi_opdte&A.08_20 OPD_.h_nhi_opdte&A.08_30
			OPD_.h_nhi_opdte&A.09_10 OPD_.h_nhi_opdte&A.09_20 OPD_.h_nhi_opdte&A.09_30
			OPD_.h_nhi_opdte&A.10_10 OPD_.h_nhi_opdte&A.10_20 OPD_.h_nhi_opdte&A.10_30
			OPD_.h_nhi_opdte&A.11_10 OPD_.h_nhi_opdte&A.11_20 OPD_.h_nhi_opdte&A.11_30
			OPD_.h_nhi_opdte&A.12_10 OPD_.h_nhi_opdte&A.12_20 OPD_.h_nhi_opdte&A.12_30 ;
		KEEP
			FUNC_DATE  AGE  ICD9CM_1  ICD9CM_2  ICD9CM_3
			T_DOT  ID  HOSP_ID  HOS ;
		RUN; 
	%END; 
%MEND; %OP94_99; 
%MACRO OP100_104; 
	%DO A=100 %TO 104; 
		DATA DATAOP.OP&A.; 
		SET 
			OPD_.h_nhi_opdte&A.01_10 OPD_.h_nhi_opdte&A.01_20 OPD_.h_nhi_opdte&A.01_30
			OPD_.h_nhi_opdte&A.02_10 OPD_.h_nhi_opdte&A.02_20 OPD_.h_nhi_opdte&A.02_30
			OPD_.h_nhi_opdte&A.03_10 OPD_.h_nhi_opdte&A.03_20 OPD_.h_nhi_opdte&A.03_30
			OPD_.h_nhi_opdte&A.04_10 OPD_.h_nhi_opdte&A.04_20 OPD_.h_nhi_opdte&A.04_30
			OPD_.h_nhi_opdte&A.05_10 OPD_.h_nhi_opdte&A.05_20 OPD_.h_nhi_opdte&A.05_30
			OPD_.h_nhi_opdte&A.06_10 OPD_.h_nhi_opdte&A.06_20 OPD_.h_nhi_opdte&A.06_30
			OPD_.h_nhi_opdte&A.07_10 OPD_.h_nhi_opdte&A.07_20 OPD_.h_nhi_opdte&A.07_30
			OPD_.h_nhi_opdte&A.08_10 OPD_.h_nhi_opdte&A.08_20 OPD_.h_nhi_opdte&A.08_30
			OPD_.h_nhi_opdte&A.09_10 OPD_.h_nhi_opdte&A.09_20 OPD_.h_nhi_opdte&A.09_30
			OPD_.h_nhi_opdte&A.10_10 OPD_.h_nhi_opdte&A.10_20 OPD_.h_nhi_opdte&A.10_30
			OPD_.h_nhi_opdte&A.11_10 OPD_.h_nhi_opdte&A.11_20 OPD_.h_nhi_opdte&A.11_30
			OPD_.h_nhi_opdte&A.12_10 OPD_.h_nhi_opdte&A.12_20 OPD_.h_nhi_opdte&A.12_30 ;
		KEEP
			FUNC_DATE  AGE  ICD9CM_1  ICD9CM_2  ICD9CM_3
			T_DOT  ID  HOSP_ID  HOS ;
		RUN; 
	%END; 
%MEND; %OP100_104; 
/*OP yearly data*/
DATA DATAOP.OP_ALL;
	SET DATAOP.OP94 DATAOP.OP95 DATAOP.OP96 DATAOP.OP97 DATAOP.OP98
			DATAOP.OP99 DATAOP.OP100 DATAOP.OP101 DATAOP.OP102 DATAOP.OP103 DATAOP.OP104;
	RUN;

/*合併 HEALTH-02_西醫住院 NHI_IPDTE to single data*/
%MACRO INP94_99; 
	%DO A= 94 %TO 99; 
		DATA DATAINP.INPALL_1; 
		SET INPD_.h_nhi_ipdte&A. ;
		KEEP ID IN_DATE IN_AGE OUT_AGE E_BED_DAY S_BED_DAY ICD9CM_1 ICD9CM_2 ICD9CM_3 ICD9CM_4 ICD9CM_5 
				MED_DOT HOSP_ID HOS;
		RUN; 
	%END; 
%MEND; %INP94_99; 
%MACRO INP100_104; 
	%DO A= 100 %TO 104; 
		DATA DATAINP.INPALL_2; 
		SET INPD_.h_nhi_ipdte&A. ;
		KEEP ID IN_DATE IN_AGE OUT_AGE E_BED_DAY S_BED_DAY ICD9CM_1 ICD9CM_2 ICD9CM_3 ICD9CM_4 ICD9CM_5 
				MED_DOT HOSP_ID HOS;
		RUN; 
	%END; 
%MEND; %INP100_104; 
/*INP yearly data*/
DATA DATAINP.INPALL;
	SET DATAINP.INPALL_1 DATAINP.INPALL_2;
	RUN;

/*合併  yearly HEALTH-11 評鑑等級 DOH_HOSB to single data*/
%MACRO HOSB; 
	%DO A= 94 %TO 99; 
		DATA DATAHSDC.HOSB_ALL_1; 
		SET HOSB_.h_doh_accmf&A. ;
		KEEP HOSP_ID CONT_TYPE ; 
		RUN; 
	%END; 
%MEND; %HOSB; 
%MACRO HOSB1; 
	%DO A= 100 %TO 104; 
		DATA DATAHSDC.HOSB_ALL_2; 
		SET HOSB_.h_doh_accmf&A. ;
		KEEP HOSP_ID CONT_TYPE ; 
		RUN; 
	%END; 
%MEND; %HOSB1; 
DATA DATAHSDC.HOSB_ALL;
	SET DATA DATAHSDC.HOSB_ALL_1 DATA DATAHSDC.HOSB_ALL_2;
	RUN;

/*合併 yearly SOCIETY-09 個人屬性檔  to single data*/
%MACRO SOC; 
	%DO A= 94 %TO 99; 
		DATA DATAHSDC.SOC_ALL_1; 
		SET SOC_.nhi_soc&A. ;
		KEEP ID MARR EDU ; 
		RUN; 
	%END; 
%MEND; %SOC; 
%MACRO SOC1; 
	%DO A= 100 %TO 104; 
		DATA DATAHSDC.SOC_ALL_2; 
		SET SOC_.nhi_soc&A. ;
		KEEP ID MARR EDU ; 
		RUN; 
	%END; 
%MEND; %SOC1; 
DATA DATAHSDC.SOC_ALL;
	SET DATA DATAHSDC.SOC_ALL_1 DATAHSDC.SOC_ALL_2;
	RUN;

/*合併 yearly HEALTH-10 死因檔  DEATH to single data*/
%MACRO DEA; 
	%DO A= 94 %TO 99; 
		DATA DATAHSDC.DEA_ALL_1; 
		SET DEA_.h_ost_death&A. ;
		KEEP ID D_DATE BIRTH_YM ; 
		RUN; 
	%END; 
%MEND; %DEA; 
%MACRO DEA1; 
	%DO A= 100%TO 104; 
		DATA DATAHSDC.DEA_ALL_2; 
		SET DEA_.h_ost_death&A. ;
		KEEP ID D_DATE BIRTH_YM ; 
		RUN; 
	%END; 
%MEND; %DEA1; 
DATA DATAHSDC.DEA_ALL;
	SET DATAHSDC.DEA_ALL_1 DATAHSDC.DEA_ALL_2;
	RUN;

/*合併 yearly CANCER to single data*/
/*HEALTH-14 癌症登記長表LF*/
%MACRO CRCMAIN; 
	%DO A= 101 %TO 101; 
		DATA DATAHSDC.CRC_ALL; 
		SET CRC_.h_bhp_crflf_2_&A. ;
		KEEP ID CSTAGE ; 
		RUN; 
	%END; 
%MEND; %CRCMAIN; 
/*HEALTH-45 癌症登記年報*/
%MACRO CRTREAT; 
	%DO A= 101 %TO 101; 
		DATA DATAHSDC.CRTX_ALL; 
		SET CRTX_.h_bhp_crssc&A. ;
		KEEP ID TX ; 
		RUN; 
	%END; 
%MEND; %CRTREAT;

/*============= DATA MERGE =============*/
/*Merge ID with Society(個人屬性)*/
	/*ID+SOC=ID_SOC*/
PROC SORT DATA=DATAID.ID_ALL;
	BY ID;
	RUN;
DATA DATAID.ID_ALL;
	SET DATAID.ID_ALL;
	IF FIRST.ID THEN OUTPUT;
	BY ID; 
	RUN;

PROC SORT DATA=DATAID.ID_ALL;
	BY ID;
	RUN;
PROC SORT DATA=DATAHSDC.SOC_ALL;
	BY ID;
	RUN;
DATA DATAID.ID_SOC;
	MERGE DATAID.ID_ALL (IN=A) DATAHSDC.SOC_ALL (IN=B);
	BY ID;
	IF A ;
	RUN;

/*Merge OUTPATIENT(門急診) with HOSB then with IDSOC*/
	/*OP+HOSB=OP_HOS*/
PROC SORT DATA=DATAHSDC.HOSB_ALL;
	BY HOSP_ID;
	RUN;
DATA DATAHSDC.HOSB_ALL;
	SET DATAHSDC.HOSB_ALL; 
	IF FIRST.HOSP_ID THEN OUTPUT; 
	BY HOSP_ID; 
	RUN; 

PROC SORT DATA=DATAHSDC.HOSB_ALL;
	BY HOSP_ID;
	RUN;
PROC SORT DATA=DATAOP.OP_ALL;
	BY HOSP_ID;
	RUN;
DATA DATAOP.OP_HOS;
	MERGE DATAOP.OP_ALL (IN=A) DATAHSDC.HOSB_ALL (IN=B);
	BY HOSP_ID;
	IF A ;
	RUN;

	/*OP_HOS+ID_SOC=ID_OP_H*/
PROC SORT DATA=DATAID.ID_SOC;
	BY ID;
	RUN;
PROC SORT DATA=DATAOP.OP_HOS;
	BY ID;
	RUN;

DATA DATAOP.ID_OP_H;
	MERGE DATAOP.OP_HOS (IN=B) DATAID.ID_SOC (IN=A);
	BY ID;
	IF A;
	RUN;

/*Merge INPATIENT with HOSB then with IDSOC*/
	/*INP+HOSB=INP_HOS*/
PROC SORT DATA=DATAINP.INP_ALL;
	BY HOSP_ID;
	RUN;
PROC SORT DATA=DATAHSDC.HOSB_ALL;
	BY HOSP_ID;
	RUN;

DATA DATAINP.INP_HOS;
	MERGE DATAINP.INP_ALL (IN=A) DATAHSDC.HOSB_ALL (IN=B);
	BY HOSP_ID;
	IF A ;
	RUN;
	/*INP_HOS+ID_SOC=ID_INP_H*/
PROC SORT DATA=DATAINP.INP_HOS;
	BY ID;
	RUN;
PROC SORT DATA=DATAID.ID_SOC;
	BY ID;
	RUN;
DATA DATAINP.ID_INP_H;
	MERGE DATAINP.INP_HOS (IN=B) DATAID.ID_SOC (IN=A);
	BY ID;
	IF A ;
	RUN;

/*Rename IN_DATE to FUNC_DATE & IN_AGE to AGE*/
DATA DATAINP.ID_INP_H;
	SET DATAINP.ID_INP_H;
	RENAME IN_DATE=FUNC_DATE;
	RENAME IN_AGE=AGE;
	RUN;

/*Merge-Stack OP and INP as ALL_1(門急診+住院=ALL)*/
DATA ALLDATA.ALL_1;
	SET DATAOP.ID_OP_H DATAINP.ID_INP_H;
	RUN;
PROC SORT DATA=ALLDATA.ALL_1;
	BY ID;
	RUN;

/*排除20歲以下者*/
DATA ALLDATA.ALL_2;
	SET ALLDATA.ALL_1;
	IF AGE>=20 THEN OUTPUT;
	RUN;

/*精神疾病*/
	/*標記精神疾病*/
DATA ALLDATA.ALL_3;
	SET ALLDATA.ALL_2;
	IF	
	SUBSTR(ICD9CM_1,1,3) IN
		('290','291','292','293','294','295','296','297','298','299' 
		,'300','301','302','303','304','305','306','307','308','309' 
		,'310','311','312','313','314','315','316','317','318','319') OR
	SUBSTR(ICD9CM_2,1,3) IN
		('290','291','292','293','294','295','296','297','298','299' 
		,'300','301','302','303','304','305','306','307','308','309' 
		,'310','311','312','313','314','315','316','317','318','319') OR
	SUBSTR(ICD9CM_3,1,3) IN
		('290','291','292','293','294','295','296','297','298','299' 
		,'300','301','302','303','304','305','306','307','308','309' 
		,'310','311','312','313','314','315','316','317','318','319') OR
	SUBSTR(ICD9CM_4,1,3) IN
		('290','291','292','293','294','295','296','297','298','299' 
		,'300','301','302','303','304','305','306','307','308','309' 
		,'310','311','312','313','314','315','316','317','318','319') OR
	SUBSTR(ICD9CM_5,1,3) IN
		('290','291','292','293','294','295','296','297','298','299' 
		,'300','301','302','303','304','305','306','307','308','309' 
		,'310','311','312','313','314','315','316','317','318','319')
	THEN MENTAL=1; 
	RUN;
	/*取出ONLY精神疾病*/
DATA DATAMEN.MENTAL_1; 
	SET ALLDATA.ALL_3;
	IF MENTAL=1 THEN OUTPUT; 
	RUN;

/*計算就醫次數*/
PROC SORT DATA=DATAMEN.MENTAL_1; 
	BY ID FUNC_DATE; 
	RUN; 
DATA MENTAL_COUNT;
	SET DATAMEN.MENTAL_1;
	BY ID;
	KEEP ID FUNC_DATE COUNT;
	IF FIRST.ID THEN COUNT = 0;
	RETAIN COUNT; COUNT + 1;
	IF LAST.ID;
	RUN;
DATA MENTAL_COUNT;
	SET MENTAL_COUNT;
	IF COUNT >1 THEN output;
	RUN;
PROC SORT DATA=MENTAL_COUNT; 
	BY ID FUNC_DATE; 
	RUN; 
DATA DATAMEN.MENTAL_2;
	MERGE DATAMEN.MENTAL_1 (IN=A) MENTAL_COUNT(IN=B);
	BY ID; 
	IF A;
	RUN;
DATA DATAMEN.MENTAL_2;
	SET DATAMEN.MENTAL_2;
	IF COUNT=. THEN DELETE;
	RUN; 
PROC SORT DATA=DATAMEN.MENTAL_2; 
	BY ID FUNC_DATE; 
	RUN; 
DATA DATAMEN.MENTAL_FIRST_1; 
	SET DATAMEN.MENTAL_2; 
	IF FIRST.ID THEN OUTPUT; 
	BY ID; 
	RUN;

TITLE "TEST:COUNT # MENTAL";
PROC FREQ DATA =  DATAMEN.MENTAL_FIRST_1;
        TABLE ID_S;
        RUN;
TITLE;

/*癌症*/
	/*標記癌症*/ 
DATA ALLDATA.ALL_4;
	SET ALLDATA.ALL_3;
	IF	
	SUBSTR(ICD9CM_1,1,3) IN 
		('140','141','142','143','144','145','146','147','148','149'
		,'150','151','152','153','154','155','156','157','158','159'
		,'160','161','162','163','164','165','166','167','168','169'
		,'170','171','172','173','174','175','176','177','178','179'
		,'180','181','182','183','184','185','186','187','188','189'
		,'190','191','192','193','194','195','196','197','198','199'
		,'200','201','202','203','204','205','206','207','208') OR
	SUBSTR(ICD9CM_2,1,3) IN 
		('140','141','142','143','144','145','146','147','148','149'
		,'150','151','152','153','154','155','156','157','158','159'
		,'160','161','162','163','164','165','166','167','168','169'
		,'170','171','172','173','174','175','176','177','178','179'
		,'180','181','182','183','184','185','186','187','188','189'
		,'190','191','192','193','194','195','196','197','198','199'
		,'200','201','202','203','204','205','206','207','208') OR
	SUBSTR(ICD9CM_3,1,3) IN 
		('140','141','142','143','144','145','146','147','148','149'
		,'150','151','152','153','154','155','156','157','158','159'
		,'160','161','162','163','164','165','166','167','168','169'
		,'170','171','172','173','174','175','176','177','178','179'
		,'180','181','182','183','184','185','186','187','188','189'
		,'190','191','192','193','194','195','196','197','198','199'
		,'200','201','202','203','204','205','206','207','208') OR
	SUBSTR(ICD9CM_4,1,3) IN 
		('140','141','142','143','144','145','146','147','148','149'
		,'150','151','152','153','154','155','156','157','158','159'
		,'160','161','162','163','164','165','166','167','168','169'
		,'170','171','172','173','174','175','176','177','178','179'
		,'180','181','182','183','184','185','186','187','188','189'
		,'190','191','192','193','194','195','196','197','198','199'
		,'200','201','202','203','204','205','206','207','208') OR
	SUBSTR(ICD9CM_5,1,3) IN 
		('140','141','142','143','144','145','146','147','148','149'
		,'150','151','152','153','154','155','156','157','158','159'
		,'160','161','162','163','164','165','166','167','168','169'
		,'170','171','172','173','174','175','176','177','178','179'
		,'180','181','182','183','184','185','186','187','188','189'
		,'190','191','192','193','194','195','196','197','198','199'
		,'200','201','202','203','204','205','206','207','208')
	THEN CANCER=1;
	RUN;

/*取出癌症*/
DATA DATACAN.CANCER_1; 
	SET ALLDATA.ALL_4;
	IF CANCER=1 THEN OUTPUT; 
	RUN;
/*排除176-187,198.6,198.82 Cancers*/
DATA DATACAN.CANCER_1; 
	SET DATACAN.CANCER_1; 
	IF 
		SUBSTR(ICD9CM_1,1,3) IN ('176','177','178','179','180','187','182','183','184','185','186','187','1986','19882') OR
		SUBSTR(ICD9CM_1,1,4) IN ('1986') OR
		SUBSTR(ICD9CM_1,1,5) IN ('19882') OR
		SUBSTR(ICD9CM_2,1,3) IN ('176','177','178','179','180','187','182','183','184','185','186','187','1986','19882') OR
		SUBSTR(ICD9CM_2,1,4) IN ('1986') OR
		SUBSTR(ICD9CM_2,1,5) IN ('19882') OR
		SUBSTR(ICD9CM_3,1,3) IN ('176','177','178','179','180','187','182','183','184','185','186','187','1986','19882') OR
		SUBSTR(ICD9CM_3,1,4) IN ('1986') OR
		SUBSTR(ICD9CM_3,1,5) IN ('19882') OR
		SUBSTR(ICD9CM_4,1,3) IN ('176','177','178','179','180','187','182','183','184','185','186','187','1986','19882') OR
		SUBSTR(ICD9CM_4,1,4) IN ('1986') OR
		SUBSTR(ICD9CM_4,1,5) IN ('19882') OR
		SUBSTR(ICD9CM_5,1,3) IN ('176','177','178','179','180','187','182','183','184','185','186','187','1986','19882') OR
		SUBSTR(ICD9CM_5,1,4) IN ('1986') OR
		SUBSTR(ICD9CM_5,1,5) IN ('19882') 
	THEN EXCLUD=1;
	RUN;	

/*計算癌症就醫次數*/
PROC SORT DATA=DATACAN.CANCER_1; 
	BY ID FUNC_DATE; 
	RUN; 
DATA CANCER_COUNT;
	SET DATACAN.CANCER_1;
	BY ID;
	KEEP ID FUNC_DATE COUNT;
	IF FIRST.ID THEN COUNT = 0;
	RETAIN COUNT; COUNT + 1;
	IF LAST.ID;
	RUN;
DATA CANCER_COUNT;
	SET CANCER_COUNT;
	IF COUNT >1 THEN OUTPUT;
	RUN;
PROC SORT DATA=CANCER_COUNT; 
	BY ID FUNC_DATE; 
	RUN; 
DATA DATACAN.CANCER_2;
	MERGE DATACAN.CANCER_1 (IN=A) CANCER_COUNT(IN=B);
	BY ID; 
	IF A;
	RUN;
DATA DATACAN.CANCER_2;
	SET DATACAN.CANCER_2;
	IF COUNT=. THEN DELETE;
	RUN; 
PROC SORT DATA=DATACAN.CANCER_2; 
	BY ID FUNC_DATE; 
	RUN; 
	/*取 First ID*/
DATA DATACAN.CANCER_FIRST_1; 
	SET DATACAN.CANCER_2; 
	IF FIRST.ID THEN OUTPUT; 
	BY ID; 
	RUN; 
/*
CAN_TYPE
0=Other
1=Oral
2=Breast
3=Colon
4=Liver
5=Lung
*/
DATA DATACAN.CANCER_FIRST_1;
		SET DATACAN.CANCER_FIRST_1;
	/*Lung*/
		IF
			SUBSTR(ICD9CM_1,1,4) IN ("1622" "1623" "1624" "1625" "1628" "1629" "1970") OR
			SUBSTR(ICD9CM_2,1,4) IN ("1622" "1623" "1624" "1625" "1628" "1629" "1970") OR
			SUBSTR(ICD9CM_3,1,4) IN ("1622" "1623" "1624" "1625" "1628" "1629" "1970") OR
			SUBSTR(ICD9CM_4,1,4) IN ("1622" "1623" "1624" "1625" "1628" "1629" "1970") OR
			SUBSTR(ICD9CM_5,1,4) IN ("1622" "1623" "1624" "1625" "1628" "1629" "1970")
			THEN CAN_TYPE=5;
	/*Liver*/
		ELSE IF 
			SUBSTR(ICD9CM_1,1,3) IN ("155") OR
			SUBSTR(ICD9CM_2,1,3) IN ("155") OR
			SUBSTR(ICD9CM_3,1,3) IN ("155") OR
			SUBSTR(ICD9CM_4,1,3) IN ("155") OR
			SUBSTR(ICD9CM_5,1,3) IN ("155") OR
			SUBSTR(ICD9CM_1,1,4) IN ("197") OR
			SUBSTR(ICD9CM_2,1,4) IN ("197") OR
			SUBSTR(ICD9CM_3,1,4) IN ("197") OR
			SUBSTR(ICD9CM_4,1,4) IN ("197") OR
			SUBSTR(ICD9CM_5,1,4) IN ("197") 
			THEN CAN_TYPE=4;
	/*Colon*/
		ELSE IF
			SUBSTR(ICD9CM_1,1,3) IN ("153" "154") OR
			SUBSTR(ICD9CM_2,1,3) IN ("153" "154") OR
			SUBSTR(ICD9CM_3,1,3) IN ("153" "154") OR
			SUBSTR(ICD9CM_4,1,3) IN ("153" "154") OR
			SUBSTR(ICD9CM_5,1,3) IN ("153" "154") OR
			SUBSTR(ICD9CM_1,1,4) IN ("1975") OR
			SUBSTR(ICD9CM_2,1,4) IN ("1975") OR
			SUBSTR(ICD9CM_3,1,4) IN ("1975") OR
			SUBSTR(ICD9CM_4,1,4) IN ("1975") OR
			SUBSTR(ICD9CM_5,1,4) IN ("1975") 
			THEN CAN_TYPE=3;
	/*Breast*/
		ELSE IF
			SUBSTR(ICD9CM_1,1,3) IN ("174" "175") OR
			SUBSTR(ICD9CM_2,1,3) IN ("174" "175") OR
			SUBSTR(ICD9CM_3,1,3) IN ("174" "175") OR
			SUBSTR(ICD9CM_4,1,3) IN ("174" "175") OR
			SUBSTR(ICD9CM_5,1,3) IN ("174" "175") OR
			SUBSTR(ICD9CM_1,1,5) IN ("19881") OR
			SUBSTR(ICD9CM_2,1,5) IN ("19881") OR
			SUBSTR(ICD9CM_3,1,5) IN ("19881") OR
			SUBSTR(ICD9CM_4,1,5) IN ("19881") OR
			SUBSTR(ICD9CM_5,1,5) IN ("19881") 
			THEN CAN_TYPE=2;
	/*Oral*/
		ELSE IF 
			SUBSTR(ICD9CM_1,1,3) IN ("140" "141" "143" "144" "145" "146" "148" "149") OR
			SUBSTR(ICD9CM_2,1,3) IN ("140" "141" "143" "144" "145" "146" "148" "149") OR
			SUBSTR(ICD9CM_3,1,3) IN ("140" "141" "143" "144" "145" "146" "148" "149") OR
			SUBSTR(ICD9CM_4,1,3) IN ("140" "141" "143" "144" "145" "146" "148" "149") OR
			SUBSTR(ICD9CM_5,1,3) IN ("140" "141" "143" "144" "145" "146" "148" "149")
			THEN CAN_TYPE=1;
		ELSE CAN_TYPE=0;
		RUN;


/*------------------------------SPLIT-----------------------------------------------------------------------------------------------------*/

TITLE"TEST:COUNT # CANCER";
PROC FREQ DATA=DATACAN.CANCER_FIRST_1;
        TABLE ID_S;
        RUN;
TITLE;


/******************************************************/
/*排除前兩年罹患精神疾病或癌症者*/
/*MEN+CAN=MC*/
DATA DATACAN.CANCER_FIRST;
		RENAME FUNC_DATE=CAN_DATE;
		RUN;
DATA DATAMEN.MENTAL_FIRST;
		RENAME FUNC_DATE=MEN_DATE;
		RUN;

PROC SORT DATA=DATACAN.CANCER_FIRST;
		BY ID ;
		RUN;
PROC SORT DATA=DATAMEN.MENTAL_FIRST;
		BY ID ;
		RUN;
DATA ALLDATA.MC;
		MERGE DATACAN.CANCER_FIRST(IN=A) DATAMEN.MENTAL_FIRST(IN=B);
		BY ID ;
		RUN;

/*把大檔有罹病者標記*/
DATA ALLDATA.MC;
        SET ALLDATA.MC;
		DISEASE=1;
        RUN;
DATA ALLDATA.ALL_4;
		SET ALLDATA.ALL_4;
		DROP CANCER MENTAL;
		RUN;

PROC SORT DATA=ALLDATA.MC;
        BY ID ;
        RUN;
PROC SORT ALLDATA.ALL_4;
		BY ID ;
		RUN;
DATA ALLDATA.ALL_5;
        MERGE ALLDATA.ALL_4(IN=A) ALLDATA.MC(IN=B);
        BY ID ;
        IF A ;
        RUN;

/*For CONTROL Group*/
DATA ALLDATA.ALL_5;
        SET ALLDATA.ALL_5;
		IF CANCER=. THEN CANCER=0;
		IF MENTAL=. THEN MENTAL=0;
		IF DISEASE=. THEN DISEASE=0;
        RUN;
DATA ALLDATA.ALL_CONTROLS;
        SET ALLDATA.ALL_5;
        IF DISEASE=0 THEN OUTPUT;
        RUN;

PROC SORT DATA=ALLDATA.ALL_CONTROLS;
		BY ID ;
		RUN;
/*CONTROL:也只抓2007-2015年份的就診紀錄*/
DATA ALLDATA.CONTROL ;
        SET ALLDATA.ALL_CONTROLS ;
        IF FIRST.ID THEN OUTPUT;
        BY ID;
        RUN;

/*CASE:排除第一次就診日期是前兩年(2005/2006)者*/
DATA ALLDATA.MC;
		SET ALLDATA.MC;
		IF SUBSTR(CAN_DATE,1,4) IN ('2005' '2006') OR SUBSTR(MEN_DATE,1,4) IN ('2005' '2006') OR EXCLUD=1 THEN DELETE;
		RUN;

/*找出LAST DATE*/
DATA DATAMEN.MENTAL_LAST;
	SET DATAMEN.MENTAL_1; 
	IF LAST.ID THEN OUTPUT; 
	BY ID; 
	RUN;
DATA DATAMEN.MENTAL_LAST;
	SET DATAMEN.MENTAL_LAST;
	LAST_DATE = FUNC_DATE;
	KEEP ID LAST_DATE;
	RUN;

DATA DATACAN.CANCER_LAST;
	SET DATACAN.CANCER_1; 
	IF LAST.ID THEN OUTPUT; 
	BY ID; 
	RUN;
DATA DATACAN.CANCER_LAST;
	SET DATACAN.CANCER_LAST;
	LAST_DATE = FUNC_DATE;
	KEEP ID LAST_DATE;
	RUN;

/*Combine all LAST instances*/
DATA ALLDATA.ALL_LAST; 
	SET DATAMEN.MENTAL_LAST  DATACAN.CANCER_LAST;
	KEEP ID LAST_DATE;
	RUN;
PROC SORT DATA=ALLDATA.ALL_LAST;
	BY ID LAST_DATE;
	RUN;
DATA ALLDATA.ALL_LAST;
	SET ALLDATA.ALL_LAST;
	IF LAST.ID THEN OUTPUT;
	BY ID;
	RUN;

/*================Split Cohort Types 罹患MD或CANCER分組編號================*/
/*Type1 = Mental Only ----*/
/*Type2 = Cancer Only----*/
/*Type3 = Cancer -> Mental ---*/ 
/*Type4 = Mental -> Cancer---*/ 
/*Type5 = Mental -> Cancer -> Mental----*/ 
DATA ALLDATA.MC_1;
	SET ALLDATA.MC;
	IF CAN_DATE=. THEN X_TYPE=1; 
	ELSE IF MEN_DATE=. THEN X_TYPE=2;
	ELSE IF CAN_DATE<MEN_DATE  THEN X_TYPE=3;
	ELSE IF MEN_DATE<CAN_DATE  THEN X_TYPE=4;
	ELSE IF MEN_DATE=CAN_DATE THEN DELETE;
	RUN;

/*從X_TYPE=4中，抓出X_TYPE=5*/
DATA ALLDATA.MC_TYPE_4;
	SET ALLDATA.MC_1;
	IF X_TYPE=4 THEN OUTPUT;
	RUN;
PROC SORT DATA=DATAMEN.MENTAL_LAST; 
	BY ID;
	RUN;
PROC SORT DATA=ALLDATA.MC_TYPE_4; 
	BY ID;
	RUN;
DATA ALLDATA.MC_45;
	MERGE ALLDATA.MC_TYPE_4 (IN=A) DATAMEN.MENTAL_LAST (IN=B);
	BY ID;
	IF A;
	RUN;
DATA ALLDATA.MC_45;
	SET ALLDATA.MC_45;
	IF LAST_DATE>CAN_DATE  THEN X_TYPE=5;
	RUN;

/*Delete Type4 from first split*/
DATA ALLDATA.MC_123; 
	SET ALLDATA.MC_1;
	IF X_TYPE=4 THEN DELETE;
	RUN;

PROC SORT DATA=ALLDATA.MC_123; 
	BY ID;
	RUN;
PROC SORT DATA=ALLDATA.MC_45; 
	BY ID;
	RUN;
/*Add Type4 and Type5 to first split*/
DATA ALLDATA.MC_12345; 
	MERGE ALLDATA.MC_123 (IN=A) ALLDATA.MC_45 (IN=B);
	BY ID;
	RUN;


/*標記有罹病的人DISEASE="1"*/
DATA ALLDATA.MC_12345;
        SET ALLDATA.MC_12345;
        DISEASE=1;
        RUN;

TITLE "各罹病順序人數";
PROC FREQ DATA=ALLDATA.MC_12345;
	TABLES X_TYPE;
	RUN;
TITLE;

/*======================DEATH==========================*/
/*抓出最後死亡日期並標示死亡*/
PROC SORT DATA=DATAHSDC.DEA_ALL;
	BY ID;
	RUN;
DATA DATAHSDC.DEA_LAST;
	SET DATAHSDC.DEA_ALL;
	IF LAST.ID THEN OUTPUT;
	BY ID;
	RUN;
DATA DATAHSDC.DEA_LAST; 
	SET DATAHSDC.DEA_LAST; 
	IF D_DATE=. THEN DELETE;
	RUN;
DATA DATAHSDC.DEATH; 
	SET DATAHSDC.DEA_LAST;
	DEATH=1;
	RENAME D_DATE=DEATH_DATE;
	RUN;

/*KEEP需要變項*/
DATA DATAHSDC.DEATH_1;
        SET DATAHSDC.DEATH;
        KEEP ID DEATH DEATH_DATE;
        RUN;

/*CASE+CONTROL(已FIRST.ID)*/
DATA ALLDATA.ALL_6;
        MERGE ALLDATA.CONTROL(IN=A)  ALLDATA.MC_12345(IN=B);
        BY ID;
        RUN;

/*MERGE回大檔*/
PROC SORT DATA=ALLDATA.ALL_6;
        BY ID;
        RUN;
PROC SORT DATA=DATAHSDC.DEATH_1;
        BY ID;
        RUN;
DATA ALLDATA.ALL_7;
        MERGE ALLDATA.ALL_6 (IN=A) DATAHSDC.DEATH_1 (IN=B);
        BY ID;
        IF A;
        RUN;

/*標記無死亡的人DEATH="0"*/
DATA ALLDATA.ALL_7;
        SET ALLDATA.ALL_7;
        IF DEATH=. THEN DEATH=0;
        RUN;

TITLE"死亡人數";
PROC FREQ DATA=ALLDATA.ALL_7;
	TABLE X_TYPE*DEATH;
	RUN;
TITLE;

/*====================CCI==================*/
DATA CCI.CASE_START;
	SET ALLDATA.MC_12345;
	KEEP ID  FIRST_IN_DATE  ;
        IF X_TYPE = "1" OR X_TYPE = "4" OR X_TYPE = "5" THEN FIRST_IN_DATE=MEN_DATE;
        ELSE IF X_TYPE = "2" OR X_TYPE = "3" THEN FIRST_IN_DATE=CAN_DATE;
	RUN;
DATA CCI.CON_START;
        SET ALLDATA.CONTROL;
        KEEP ID FIRST_IN_DATE ;
        FIRST_IN_DATE=FUNC_DATE;
        RUN;

/*排序*/
DATA CCI.START;
        SET CCI.CASE_START CCI.CON_START;
        RUN;
PROC SORT DATA=CCI.START;
        BY ID ;
        RUN;
PROC SORT DATA=ALLDATA.ALL_5;
        BY ID ;
        RUN;
/*MERGE*/
DATA CCI.START_1;
        MERGE ALLDATA.ALL_5(IN=A) CCI.START(IN=B);
        BY ID ;
        IF B;
        RUN;

/*收案後兩年納入CCI範圍*/
DATA CCI.START_2;
        SET CCI.START_1;
  	INDATE=INPUT(FUNC_DATE,YYMMDD10.);
  	FIRSTDATE=INPUT(FIRST_IN_DATE,YYMMDD10.);
  	IF 0<=INDATE-FIRSTDATE<=730 THEN OUTPUT ;
        RUN;

	/*CCI給分*/
%MACRO CCI; 
	%DO A= 1 %TO 5; 
		DATA CCI.START_3;
        	SET CCI.START_2;
						IF			SUBSTR(ICD9CM_&A.,1,3) IN ('410','412' )
				THEN	ICD9CM_&A.= 'A1';
			ELSE IF	SUBSTR(ICD9CM_&A.,1,3) IN ('428')
				THEN	ICD9CM_&A.='B1';
			ELSE IF	SUBSTR(ICD9CM_&A.,1,3) IN ('441') OR  
							SUBSTR(ICD9CM_&A.,1,4) IN ('4439','7854','V434')
				THEN	ICD9CM_&A.='C1';
			ELSE IF	SUBSTR(ICD9CM_&A.,1,3) IN ('430','431','432','433','434','435','436','437','438')
				THEN	ICD9CM_&A.='D1';
			ELSE IF	SUBSTR(ICD9CM_&A.,1,3) IN ('290')
				THEN	ICD9CM_&A.='E1';
			ELSE IF	SUBSTR(ICD9CM_&A.,1,3) IN ('490','491','492','493','494','495','496','500','501','502','503','504','505') OR 
							SUBSTR(ICD9CM_&A.,1,4) IN ('5064') 
				THEN	ICD9CM_&A.='F1';
			ELSE IF	SUBSTR(ICD9CM_&A.,1,3) IN ('725') OR 
							SUBSTR(ICD9CM_&A.,1,4) IN ('7100','7101','7104','7140','7141','7142') OR 
							SUBSTR(ICD9CM_&A.,1,5) IN ('71481')
				THEN ICD9CM_&A.='G1';
			ELSE IF	SUBSTR(ICD9CM_&A.,1,4) IN 
									('5310','5311','5312','5313','5314','5315','5316','5317','5319'
									,'5320','5321','5322','5323','5324','5325','5326','5327','5329'
									,'5330','5331','5332','5333','5334','5335','5336','5337','5339'
									,'5340','5341','5342','5343','5344','5345','5346','5347','5349') 
				THEN	ICD9CM_&A.='H1';
			ELSE IF	SUBSTR(ICD9CM_&A.,1,4) IN ('5712','5714','5715','5716')
				THEN	ICD9CM_&A.='I1';
				/*DM(1分,J1)*/
			ELSE IF	SUBSTR(ICD9CM_&A.,1,4) IN ('2500','2501','2502','2503','2507') 
				THEN	ICD9CM_&A.='J1';
				/*DM(1分,J1)*/
				/*DM(2分,A2)*/
			ELSE IF	SUBSTR(ICD9CM_&A.,1,4) IN ('2504','2505','2506') 
				THEN	ICD9CM_&A.='A2';
				/*DM(2分,A2)*/
			ELSE IF	SUBSTR(ICD9CM_&A.,1,3) IN ('342') OR 
							SUBSTR(ICD9CM_&A.,1,4) IN ('3441')
				THEN	ICD9CM_&A.='B2';
			ELSE IF	SUBSTR(ICD9CM_&A.,1,3) IN ('582','585','586','588')  OR 
							SUBSTR(ICD9CM_&A.,1,4) IN ('5830','5831','5832','5833','5834','5835','5836','5837')
				THEN	ICD9CM_&A.='C2';
			ELSE IF	SUBSTR(ICD9CM_&A.,1,3) IN 
								('140','141','142','143','144','145','146','147','148','149'
								,'150','151','152','153','154','155','156','157','158','159'
								,'160','161','162','163','164','165','166','167','168','169'
								,'170','171','172','174','175','176','177','178','179'
								,'180','181','182','183','184','185','186','187','188','189'
								,'190','191','192','193','194','195','200')
				THEN	ICD9CM_&A.='D2';
			ELSE IF	SUBSTR(ICD9CM_&A.,1,3) IN ('208')
				THEN	ICD9CM_&A.='E2';

			ELSE IF	SUBSTR(ICD9CM_&A.,1,4) IN ('4560','4561','4562','5722','5723','5724','5725','5726','5727','5728') 
				THEN	ICD9CM_&A.='A3';
			ELSE IF	SUBSTR(ICD9CM_&A.,1,3) IN ('196','197','198','199')
				THEN	ICD9CM_&A.='A6';
			ELSE IF	SUBSTR(ICD9CM_&A.,1,3) IN ('042','043','044')
				THEN	ICD9CM_&A.='B6';
			ELSE IF	ICD9CM_&A.^='A1' OR ICD9CM_&A.^='B1' OR ICD9CM_&A.^='C1' OR 
							ICD9CM_&A.^='D1' OR ICD9CM_&A.^='E1' OR ICD9CM_&A.^='F1' OR
							ICD9CM_&A.^='G1' OR ICD9CM_&A.^='H1' OR ICD9CM_&A.^='I1' OR
							ICD9CM_&A.^='J1' OR
							ICD9CM_&A.^='A2' OR ICD9CM_&A.^='B2' OR ICD9CM_&A.^='C2' OR
							ICD9CM_&A.^='D2' OR ICD9CM_&A.^='E2' OR
							ICD9CM_&A.^='A3' OR
							ICD9CM_&A.^='A6' OR ICD9CM_&A.^='B6'
				THEN	ICD9CM_&A.='X0';
		RUN; 
	%END; 
%MEND; %CCI; 

/*把ICD編碼拆開在合併後取出第一筆*/
DATA CCI.CODE_1;
        SET CCI.START_3;
	KEEP ID CODING ;
	CODING=ICD9CM_1;
	RUN;
DATA CCI.CODE_2;
	SET CCI.START_3;
	KEEP ID CODING ;
	CODING=ICD9CM_2;
	RUN;
DATA CCI.CODE_3;
	SET CCI.START_3;
	KEEP ID CODING ;
	CODING=ICD9CM_3;
	RUN;
DATA CCI.CODE_4;
	SET CCI.START_3;
	KEEP ID CODING ;
	CODING=ICD9CM_4;
	RUN;
DATA CCI.CODE_5;
	SET CCI.START_3;
	KEEP ID CODING ;
	CODING=ICD9CM_5;
	RUN;
DATA CCI.CODE_ALL;
	SET CCI.CODE_1 CCI.CODE_2 CCI.CODE_3 CCI.CODE_4 CCI.CODE_5;
	RUN;
PROC SORT DATA=CCI.CODE_ALL;
	BY ID  CODING;
	RUN;
DATA CCI.CODE_ALL;
	SET CCI.CODE_ALL;
	IF FIRST.CODING THEN OUTPUT;
	BY ID CODING;
	RUN;

/*標記疾病病程有變化者*/
        /*惡性腫瘤(D2)->轉移性腫瘤(A6)*/
        /*輕度肝臟疾病(I1)->中重度肝臟疾病(A3)*/
        /*DM(J1)->DM+末端器官衰竭(A2)*/
DATA CCI.CODE_DIFF;
	SET CCI.CODE_ALL;
	IF CODING = 'D2' THEN OUTPUT;
	IF CODING = 'A6' THEN OUTPUT;
	IF CODING = 'I1' THEN OUTPUT;
	IF CODING = 'A3' THEN OUTPUT;
	IF CODING = 'J1' THEN OUTPUT;
	IF CODING = 'A2' THEN OUTPUT;
	RUN;
PROC SORT DATA=CCI.CODE_DIFF;
	BY ID CODING;
	RUN;
DATA CCI.CODE_DIFF;
	SET CCI.CODE_DIFF;
	IF LAST.CODING THEN OUTPUT;
	BY ID CODING;
	RUN;
DATA CCI.CODE_DIFF;
	SET CCI.CODE_DIFF;
	KEEP ID CCI_TYPE;
	IF CODING = 'A6' OR CODING = 'A3' OR CODING = 'A2' THEN CCI_TYPE=1;
	RUN;
PROC SORT DATA=CCI.CODE_DIFF;
	BY ID ;
	RUN;
PROC SORT DATA=CCI.CODE_ALL;
	BY ID ;
	RUN;
DATA CCI.CODE_ALL_1;
	MERGE CCI.CODE_DIFF(IN=A) CCI.CODE_ALL(IN=B);
	BY ID ;
	IF B;
	RUN;
/*刪除疾病嚴重度已變化者*/
DATA CCI.CODE_ALL_2;
	SET CCI.CODE_ALL_1;
	IF CODING = 'D2' AND CCI_TYPE = 1 THEN DELETE ;
	IF CODING = 'I1' AND CCI_TYPE = 1 THEN DELETE ;
	IF CODING = 'J1' AND CCI_TYPE = 1 THEN DELETE ;
	RUN;
/*取得CCI分數*/
DATA CCI.CODE_ALL_2;
	SET CCI.CODE_ALL_2;
	CCI_SCORE=SUBSTR(CODING,2,1);
	RUN;
/*CCI分數加總*/
PROC SORT DATA= CCI.CODE_ALL_2;
	BY ID CCI_SCORE;
	RUN;
DATA CCI.CODE_ALL_3;
	SET CCI.CODE_ALL_2;
	BY ID ;
	IF FIRST.ID THEN CCI_SUM=0;
	CCI_SUM+CCI_SCORE;
	RUN;
/*取尾筆*/
PROC SORT DATA = CCI.CODE_ALL_3;
	BY ID ;
	RUN;
DATA CCI.CODE_ALL_4;
	SET CCI.CODE_ALL_3;
	BY ID ;
	IF LAST.ID THEN OUTPUT;
	RUN;
DATA CCI.CODE_LAST;
	SET CCI.CODE_ALL_4;
	KEEP ID CCI_SUM;
	RUN;
